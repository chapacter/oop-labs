{
  "info": {
    "name": "lab5-api-collection",
    "_postman_id": "lab5-collection-0001",
    "description": "Collection for Lab5 API (framework) - fixed order and env vars to avoid 404s; collection prerequest sets authHeader from env username/password.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Admin - clear",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/admin/clear",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "admin",
            "clear"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 200', () => pm.expect(pm.response.code).to.be.oneOf([200]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Admin - populate",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/admin/populate?functions={{functions}}&pointsPerFunction={{pointsPerFunction}}&batchSize={{batchSize}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "admin",
            "populate"
          ],
          "query": [
            {
              "key": "functions",
              "value": "{{functions}}"
            },
            {
              "key": "pointsPerFunction",
              "value": "{{pointsPerFunction}}"
            },
            {
              "key": "batchSize",
              "value": "{{batchSize}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status is 200 or 202', () => pm.expect(pm.response.code).to.be.oneOf([200,202]));",
              "pm.test('Has json or text', () => pm.expect(pm.response.text()).to.be.ok);",
              "// If populate creates seed_user, set creds in environment so later requests authenticate",
              "pm.environment.set('username', 'seed_user');",
              "pm.environment.set('password', 'pass');",
              "pm.environment.set('authHeader', 'Basic ' + btoa('seed_user:pass'));",
              "console.log('seed creds set: seed_user / pass');"
            ]
          }
        }
      ]
    },
    {
      "name": "Users - find seed_user",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/users?page=0&size=20&name=seed_user",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "users"
          ],
          "query": [
            {
              "key": "page",
              "value": "0"
            },
            {
              "key": "size",
              "value": "20"
            },
            {
              "key": "name",
              "value": "seed_user"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));",
              "try { const json = pm.response.json(); if (json && json.content && Array.isArray(json.content) && json.content.length>0) { const id = json.content[0].id; pm.environment.set('seedUserId', id); pm.environment.set('fUserId', id); pm.environment.set('userId', id); console.log('seedUserId=',id); } else { console.log('seed_user not found'); } } catch(e){console.log('parse err',e);}"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - pick-or-create-for-seed",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/functions?page=0&size=1&name=&userId={{seedUserId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions"
          ],
          "query": [
            {
              "key": "page",
              "value": "0"
            },
            {
              "key": "size",
              "value": "1"
            },
            {
              "key": "name",
              "value": ""
            },
            {
              "key": "userId",
              "value": "{{seedUserId}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));",
              "try { const json = pm.response.json(); if (json && json.content && Array.isArray(json.content) && json.content.length>0) { const fid = json.content[0].id; pm.environment.set('funcId', fid); pm.environment.set('pFunctionId', fid); console.log('picked existing funcId=',fid); } else { console.log('no func for seed, creating'); const body = { name: 'func_auto_' + Date.now(), format: null, userId: pm.environment.get('seedUserId')||1, funcResult: 'result' }; pm.sendRequest({ url: pm.environment.get('baseUrl') + '/api/functions', method: 'POST', header: { 'Content-Type':'application/json', 'Authorization': pm.environment.get('authHeader') }, body:{mode:'raw', raw: JSON.stringify(body)} }, function(err,res){ pm.expect(err).to.be.null; pm.test('created func ok', () => pm.expect(res.code).to.be.oneOf([200,201])); try{ const j = res.json(); if(j && j.id){ pm.environment.set('funcId', j.id); pm.environment.set('pFunctionId', j.id); console.log('created funcId=',j.id);} }catch(e){console.log('create parse fail',e);} }); } } catch(e){console.log('err',e);}"
            ]
          }
        }
      ]
    },
    {
      "name": "Users - list",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/users?page={{page}}&size={{size}}&name={{name}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "users"
          ],
          "query": [
            {
              "key": "page",
              "value": "{{page}}"
            },
            {
              "key": "size",
              "value": "{{size}}"
            },
            {
              "key": "name",
              "value": "{{name}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));",
              "pm.test('Has content array', () => { const json = pm.response.json(); pm.expect(json).to.have.property('content'); });"
            ]
          }
        }
      ]
    },
    {
      "name": "Users - get (seed or current)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Accept",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/users/{{seedUserId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "users",
            "{{seedUserId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Users - create (test user)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"new_user_{{$timestamp}}\",\n  \"password\": \"pass\",\n  \"accessLvl\": 1\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/users",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "users"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('201 or 200', () => pm.expect(pm.response.code).to.be.oneOf([200,201]));",
              "try { const j = pm.response.json(); if (j && j.id) { pm.environment.set('createdUserId', j.id); console.log('createdUserId=', j.id); } } catch(e) { console.log('Users-create parse fail', e); }"
            ]
          }
        }
      ]
    },
    {
      "name": "Users - update (createdUserId)",
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"name\": \"updated_user_{{$iteration}}\", \"accessLvl\": 2 }"
        },
        "url": {
          "raw": "{{baseUrl}}/api/users/{{createdUserId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "users",
            "{{createdUserId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - list (for seed user)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/functions?page=0&size={{size}}&name=&userId={{seedUserId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions"
          ],
          "query": [
            {
              "key": "page",
              "value": "0"
            },
            {
              "key": "size",
              "value": "{{size}}"
            },
            {
              "key": "name",
              "value": ""
            },
            {
              "key": "userId",
              "value": "{{seedUserId}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - get (funcId)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/functions/{{funcId}}?withPoints={{withPoints}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions",
            "{{funcId}}"
          ],
          "query": [
            {
              "key": "withPoints",
              "value": "{{withPoints}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - create (use seedUserId)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"func_new_{{$iteration}}\",\n  \"format\": null,\n  \"userId\": {{seedUserId}},\n  \"funcResult\": \"result\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/functions",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('201 or 200', () => pm.expect(pm.response.code).to.be.oneOf([200,201]));",
              "try { const j = pm.response.json(); if (j && j.id) { pm.environment.set('funcId', j.id); pm.environment.set('pFunctionId', j.id); console.log('new funcId=', j.id); } } catch(e) {}"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - update (funcId)",
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"name\":\"upd_{{$iteration}}\", \"format\":1 }"
        },
        "url": {
          "raw": "{{baseUrl}}/api/functions/{{funcId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions",
            "{{funcId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - by user (seedUserId)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/functions/by-user/{{seedUserId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions",
            "by-user",
            "{{seedUserId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));"
            ]
          }
        }
      ]
    },
    {
      "name": "Points - list (for func)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/points?functionId={{pFunctionId}}&page={{page}}&size={{size}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "points"
          ],
          "query": [
            {
              "key": "functionId",
              "value": "{{pFunctionId}}"
            },
            {
              "key": "page",
              "value": "{{page}}"
            },
            {
              "key": "size",
              "value": "{{size}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));"
            ]
          }
        }
      ]
    },
    {
      "name": "Points - get",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/points/{{pointId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "points",
            "{{pointId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Points - create (use pFunctionId)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"functionId\": {{pFunctionId}}, \"indexInFunction\": 0, \"x\": 1.1, \"y\": 2.2 }"
        },
        "url": {
          "raw": "{{baseUrl}}/api/points",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "points"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('201 or 200', () => pm.expect(pm.response.code).to.be.oneOf([200,201]));",
              "try { const j = pm.response.json(); if (j && j.id) { pm.environment.set('pointId', j.id); console.log('created pointId=', j.id); } } catch(e) {}"
            ]
          }
        }
      ]
    },
    {
      "name": "Points - update (pointId)",
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"indexInFunction\": 1, \"x\": 2.0 }"
        },
        "url": {
          "raw": "{{baseUrl}}/api/points/{{pointId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "points",
            "{{pointId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Points - delete (pointId)",
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/points/{{pointId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "points",
            "{{pointId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 204 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,204,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Functions - delete (funcId)",
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/functions/{{funcId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "functions",
            "{{funcId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200 or 204 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,204,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Users - delete (createdUserId)",
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/users/{{createdUserId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "users",
            "{{createdUserId}}"
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('204 or 200 or 404', () => pm.expect(pm.response.code).to.be.oneOf([200,204,404]));"
            ]
          }
        }
      ]
    },
    {
      "name": "Search - bfs",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/search/bfs?start={{start}}&field={{field}}&value={{value}}&limit={{limit}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "search",
            "bfs"
          ],
          "query": [
            {
              "key": "start",
              "value": "{{start}}"
            },
            {
              "key": "field",
              "value": "{{field}}"
            },
            {
              "key": "value",
              "value": "{{value}}"
            },
            {
              "key": "limit",
              "value": "{{limit}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));"
            ]
          }
        }
      ]
    },
    {
      "name": "Search - dfs",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{authHeader}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/search/dfs?start={{start}}&field={{field}}&value={{value}}&limit={{limit}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "api",
            "search",
            "dfs"
          ],
          "query": [
            {
              "key": "start",
              "value": "{{start}}"
            },
            {
              "key": "field",
              "value": "{{field}}"
            },
            {
              "key": "value",
              "value": "{{value}}"
            },
            {
              "key": "limit",
              "value": "{{limit}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('200', () => pm.expect(pm.response.code).to.eql(200));"
            ]
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "exec": [
          "// collection prerequest: compute authHeader from username/password saved in env (do not mutate pm.request)",
          "const user = pm.environment.get('username');",
          "const pass = pm.environment.get('password');",
          "if (user && pass) {",
          "  try {",
          "    const header = 'Basic ' + btoa(user + ':' + pass);",
          "    pm.environment.set('authHeader', header);",
          "    console.log('authHeader set from env username/password');",
          "  } catch(e) {",
          "    console.log('Failed to compute authHeader:', e);",
          "  }",
          "} else {",
          "  pm.environment.unset('authHeader');",
          "  console.log('username/password not set in environment â€” no authHeader');",
          "}"
        ]
      }
    }
  ],
  "variable": []
}
